@using System.Text.Json
@inherits IgnisAsyncComponentBase
@* ReSharper disable once InconsistentNaming *@
@inject IJSRuntime JSRuntime
@inject ILocalStorage LocalStorage
@inject IStringLocalizer<ThemeSelector> Resources

<Listbox AsElement="div"
         @bind-Value="SelectedTheme"
         @attributes="Attributes">
    <ListboxLabel class="sr-only">
        @Resources["Label"]
    </ListboxLabel>
    <ListboxButton class="flex h-6 w-6 items-center justify-center rounded-lg shadow-md shadow-black/5 ring-1 ring-black/5 dark:bg-slate-700 dark:ring-inset dark:ring-white/5"
                   aria-label="@Resources["Theme_" + SelectedTheme]">
        <ThemeLightIcon class="hidden h-4 w-4 fill-sky-400 [[data-theme=light]_&]:block"/>
        <ThemeDarkIcon class="hidden h-4 w-4 fill-sky-400 [[data-theme=dark]_&]:block"/>
        <ThemeLightIcon class="hidden h-4 w-4 fill-slate-400 [:not(.dark)[data-theme=system]_&]:block"/>
        <ThemeDarkIcon class="hidden h-4 w-4 fill-slate-400 [.dark[data-theme=system]_&]:block"/>
    </ListboxButton>
</Listbox>

@code
{
    private Theme _selectedTheme;

    private Theme SelectedTheme
    {
        get => _selectedTheme;
        set
        {
            _selectedTheme = value;
            JSRuntime.InvokeVoidAsync("setTheme", JsonSerializer.Serialize(value));
        }
    }

    [Parameter(CaptureUnmatchedValues = true)]
    public IReadOnlyDictionary<string, object?>? Attributes { get; set; }

    protected override async Task OnInitializedAsync(CancellationToken cancellationToken)
    {
        _selectedTheme = await LocalStorage.GetItemAsync<Theme?>("theme") ?? Theme.System;
    }

    private enum Theme
    {
        System,
        Light,
        Dark
    }
}